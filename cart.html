<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBusiness Cart</title>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Overall Cart Container */
      .cart-container {
        padding: 20px;
        background: #f4f4f4;
        min-height: calc(100vh - 140px);
      }
      .cart-container h1 {
        margin-bottom: 20px;
        font-size: 2rem;
        color: #007bff;
      }
      /* Global Delete Selected Button */
      .delete-selected {
        display: block;
        margin-bottom: 15px;
        background: #dc3545;
        border: none;
        color: #fff;
        padding: 8px 15px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .delete-selected:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .delete-selected:hover:not(:disabled) {
        background: #c82333;
      }
      /* Cart Item Styles */
      .cart-item {
        display: flex;
        align-items: center;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .cart-item input[type="checkbox"] {
        margin-right: 10px;
      }
      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
        transition: none !important;
      }
      .cart-item-details {
        flex: 1;
      }
      .cart-item-details h3 {
        font-size: 1.2rem;
        margin-bottom: 8px;
        color: #333;
      }
      .cart-item-details p {
        margin: 4px 0 10px 0;
        color: #666;
      }
      /* Vertical Quantity Controls on RHS */
      .quantity-vertical {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-left: 15px;
      }
      .quantity-vertical button {
        background: #007bff;
        border: none;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .quantity-vertical button:hover {
        background: #0069d9;
      }
      .quantity-vertical span {
        margin: 8px 0;
        font-size: 1rem;
        min-width: 20px;
        text-align: center;
      }
      /* Cart Total and Checkout */
      .cart-total {
        text-align: right;
        font-size: 1.3rem;
        font-weight: bold;
        margin-top: 20px;
      }
      .checkout-button {
        background: #28a745;
        border: none;
        color: #fff;
        padding: 12px 25px;
        font-size: 1rem;
        border-radius: 25px;
        cursor: pointer;
        margin-top: 20px;
        float: right;
        transition: background-color 0.3s;
      }
      .checkout-button:hover {
        background: #218838;
      }
      .empty-cart {
        text-align: center;
        font-size: 1.2rem;
        margin-top: 50px;
        color: #666;
      }
      /* Detailed Receipt Section */
      .receipt {
        margin-top: 30px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .receipt h2 {
        font-size: 1.5rem;
        color: #007bff;
        margin-bottom: 15px;
      }
      .receipt table {
        width: 100%;
        border-collapse: collapse;
      }
      .receipt th,
      .receipt td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .receipt th {
        background: #f4f4f4;
      }
      /* Token System Section */
      .token-section {
        margin-top: 30px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .token-section h2 {
        font-size: 1.5rem;
        color: #007bff;
        margin-bottom: 15px;
      }
      .token-section input {
        padding: 8px;
        font-size: 1rem;
        width: 150px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
      }
      .token-section button {
        padding: 8px 15px;
        font-size: 1rem;
        border: none;
        background: #28a745;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .token-section button:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <!-- External Header -->
    <div id="header-placeholder"></div>
    
    <!-- Main Cart Content -->
    <main class="cart-container">
      <h1>Your Shopping Cart</h1>
      <!-- Global Delete Selected Button -->
      <button class="delete-selected" id="delete-selected" disabled>Delete Selected</button>
      
      <div id="cart-items">
        <!-- Dynamic cart items will be rendered here -->
      </div>
      <div class="cart-total" id="cart-total">Total: $0.00</div>
      <button class="checkout-button" id="checkout-button">
        Proceed to Checkout
      </button>
      
      <!-- Detailed Receipt Section -->
      <div class="receipt" id="detailed-receipt">
        <h2>Order Details</h2>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody id="receipt-body">
            <!-- Receipt details will be rendered here -->
          </tbody>
        </table>
      </div>
      
      <!-- Token System Section -->
      <div class="token-section">
        <h2>Apply Tokens</h2>
        <p>You have <span id="user-tokens">50</span> tokens available.</p>
        <input type="number" id="token-input" placeholder="Tokens to apply" min="0" />
        <button id="apply-tokens">Apply Tokens</button>
        <p id="token-message"></p>
      </div>
    </main>
    
    <!-- External Footer -->
    <div id="footer-placeholder"></div>
    
    <!-- JavaScript for cart functionality -->
    <script>
      /*
        This frontend code uses dummy data and is structured for future integration with Firebase.
        Global state management here (cartItems, tokens, etc.) will eventually be replaced with Firebase Firestore calls.
      */
      
      // Global cart items (dummy data)
      let cartItems = [
        { id: 1, name: "Product 1", price: 29.99, quantity: 1, image: "https://via.placeholder.com/80" },
        { id: 2, name: "Product 2", price: 49.99, quantity: 2, image: "https://via.placeholder.com/80" },
        { id: 3, name: "Product 3", price: 19.99, quantity: 1, image: "https://via.placeholder.com/80" }
      ];
      
      // Token system: dummy user tokens and applied tokens
      let userTokens = 50;
      let appliedTokens = 0;
      
      // Debounce timer for quantity updates
      let updateTimer;
      const DEBOUNCE_DELAY = 300; // milliseconds
      
      // Render the cart items, update totals, and display a detailed receipt.
      const renderCart = () => {
        const cartItemsContainer = document.getElementById("cart-items");
        const cartTotalContainer = document.getElementById("cart-total");
        const receiptBody = document.getElementById("receipt-body");
        const deleteSelectedBtn = document.getElementById("delete-selected");
        
        if (cartItems.length === 0) {
          cartItemsContainer.innerHTML = '<p class="empty-cart">Your cart is empty.</p>';
          cartTotalContainer.innerText = "Total: $0.00";
          receiptBody.innerHTML = "";
          deleteSelectedBtn.disabled = true;
          return;
        }
        
        let total = 0;
        cartItemsContainer.innerHTML = "";
        receiptBody.innerHTML = "";
        
        cartItems.forEach(item => {
          const lineTotal = item.price * item.quantity;
          total += lineTotal;
          
          // Create cart item element with checkbox, details, and vertical quantity controls on the right.
          const itemEl = document.createElement("div");
          itemEl.className = "cart-item";
          itemEl.innerHTML = `
            <input type="checkbox" class="delete-checkbox" data-id="${item.id}" />
            <img src="${item.image}" alt="${item.name}" />
            <div class="cart-item-details">
              <h3>${item.name}</h3>
              <p>$${item.price.toFixed(2)} x ${item.quantity} = $${lineTotal.toFixed(2)}</p>
            </div>
            <div class="quantity-vertical">
              <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" title="Increase Quantity">
                <i class="fas fa-plus"></i>
              </button>
              <span id="quantity-${item.id}">${item.quantity}</span>
              <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" title="Decrease Quantity">
                <i class="fas fa-minus"></i>
              </button>
            </div>
          `;
          cartItemsContainer.appendChild(itemEl);
          
          // Render detailed receipt row.
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>$${lineTotal.toFixed(2)}</td>
          `;
          receiptBody.appendChild(row);
        });
        
        // Apply token discount: assume each token gives a $0.10 discount.
        const tokenDiscount = appliedTokens * 0.10;
        const finalTotal = Math.max(total - tokenDiscount, 0);
        cartTotalContainer.innerText = "Total: $" + finalTotal.toFixed(2);
        
        // Enable "Delete Selected" button if any checkbox is checked.
        const anyChecked = document.querySelectorAll(".delete-checkbox:checked").length > 0;
        deleteSelectedBtn.disabled = !anyChecked;
      };
      
      // Debounced update for quantity changes.
      function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) return;
        const index = cartItems.findIndex(item => item.id === itemId);
        if (index > -1) {
          cartItems[index].quantity = newQuantity;
          clearTimeout(updateTimer);
          updateTimer = setTimeout(renderCart, DEBOUNCE_DELAY);
        }
      }
      
      // Remove selected items based on checkboxes.
      function deleteSelectedItems() {
        const checkedBoxes = document.querySelectorAll(".delete-checkbox:checked");
        if (checkedBoxes.length === 0) return;
        
        if (!confirm("Are you sure you want to delete the selected items?")) return;
        
        const idsToDelete = Array.from(checkedBoxes).map(cb => parseInt(cb.getAttribute("data-id")));
        cartItems = cartItems.filter(item => !idsToDelete.includes(item.id));
        renderCart();
      }
      
      // Load external HTML for header and footer.
      const loadHTML = (elementId, filePath) => {
        fetch(filePath)
          .then(response => {
            if (!response.ok) throw new Error("Error fetching " + filePath);
            return response.text();
          })
          .then(html => { document.getElementById(elementId).innerHTML = html; })
          .catch(error => console.error(error));
      };
      
      // Apply tokens to the order.
      function applyTokens() {
        const tokenInput = document.getElementById("token-input");
        const tokensToApply = parseInt(tokenInput.value);
        const tokenMessage = document.getElementById("token-message");
        
        if (isNaN(tokensToApply) || tokensToApply < 0) {
          tokenMessage.innerText = "Please enter a valid number of tokens.";
          return;
        }
        if (tokensToApply > userTokens) {
          tokenMessage.innerText = "You do not have enough tokens.";
          return;
        }
        appliedTokens = tokensToApply;
        tokenMessage.innerText = "Tokens applied: " + appliedTokens;
        renderCart();
      }
      
      // Activate header hamburger icon if present.
      function activateHeaderMenu() {
        const menuToggle = document.querySelector(".menu-toggle");
        if (menuToggle) {
          menuToggle.addEventListener("click", () => {
            const sideMenu = document.getElementById("side-menu");
            if (sideMenu) sideMenu.classList.toggle("visible");
          });
        }
      }
      
      // Initialize the cart page on DOM load.
      document.addEventListener("DOMContentLoaded", () => {
        renderCart();
        loadHTML("header-placeholder", "header.html");
        loadHTML("footer-placeholder", "footer.html");
        document.getElementById("apply-tokens").addEventListener("click", applyTokens);
        document.getElementById("checkout-button").addEventListener("click", () => {
          alert("Proceeding to checkout...");
        });
        document.getElementById("delete-selected").addEventListener("click", deleteSelectedItems);
        // Display the available tokens.
        document.getElementById("user-tokens").innerText = userTokens;
        activateHeaderMenu();
        
        // Enable/disable global delete button when checkboxes change.
        document.addEventListener("change", event => {
          if (event.target.classList.contains("delete-checkbox")) {
            const anyChecked = document.querySelectorAll(".delete-checkbox:checked").length > 0;
            document.getElementById("delete-selected").disabled = !anyChecked;
          }
        });
      });
    </script>
  </body>
</html>
