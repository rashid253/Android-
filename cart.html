<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MyBusiness Cart</title>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />
    <style>
      /* Additional styles for the Cart page */
      .cart-container {
        padding: 20px;
        background: #f4f4f4;
        min-height: calc(100vh - 140px);
      }
      .cart-container h1 {
        margin-bottom: 20px;
        font-size: 2rem;
        color: #007bff;
      }
      .cart-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        margin-bottom: 15px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .cart-item img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        margin-right: 15px;
        transition: none !important; /* Prevent image shaking on re-render */
      }
      .cart-item-details {
        flex: 1;
      }
      .cart-item-details h3 {
        font-size: 1.2rem;
        margin-bottom: 8px;
        color: #333;
      }
      .cart-item-details p {
        margin: 4px 0 10px 0;
        color: #666;
      }
      .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .quantity-controls button {
        background: #007bff;
        border: none;
        color: #fff;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .quantity-controls button:hover {
        background: #0069d9;
      }
      .quantity-controls span {
        min-width: 20px;
        text-align: center;
        font-size: 1rem;
      }
      /* Remove button styling (alternative deletion method) */
      .remove-button {
        background: none;
        border: none;
        color: #dc3545;
        font-size: 0.9rem;
        cursor: pointer;
        text-decoration: underline;
        margin-top: 8px;
      }
      .remove-button:hover {
        color: #c82333;
      }
      .cart-total {
        text-align: right;
        font-size: 1.3rem;
        font-weight: bold;
        margin-top: 20px;
      }
      .checkout-button {
        background: #28a745;
        border: none;
        color: #fff;
        padding: 12px 25px;
        font-size: 1rem;
        border-radius: 25px;
        cursor: pointer;
        margin-top: 20px;
        float: right;
        transition: background-color 0.3s;
      }
      .checkout-button:hover {
        background: #218838;
      }
      .empty-cart {
        text-align: center;
        font-size: 1.2rem;
        margin-top: 50px;
        color: #666;
      }
      /* Detailed Receipt Section */
      .receipt {
        margin-top: 30px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .receipt h2 {
        font-size: 1.5rem;
        color: #007bff;
        margin-bottom: 15px;
      }
      .receipt table {
        width: 100%;
        border-collapse: collapse;
      }
      .receipt th,
      .receipt td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }
      .receipt th {
        background: #f4f4f4;
      }
      /* Token System Section */
      .token-section {
        margin-top: 30px;
        background: #fff;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .token-section h2 {
        font-size: 1.5rem;
        color: #007bff;
        margin-bottom: 15px;
      }
      .token-section input {
        padding: 8px;
        font-size: 1rem;
        width: 150px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 10px;
      }
      .token-section button {
        padding: 8px 15px;
        font-size: 1rem;
        border: none;
        background: #28a745;
        color: #fff;
        border-radius: 4px;
        cursor: pointer;
        transition: background 0.3s;
      }
      .token-section button:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <!-- External Header -->
    <div id="header-placeholder"></div>
    
    <!-- Main Cart Content -->
    <main class="cart-container">
      <h1>Your Shopping Cart</h1>
      <div id="cart-items">
        <!-- Dynamic cart items will be rendered here -->
      </div>
      <div class="cart-total" id="cart-total">Total: $0.00</div>
      <button class="checkout-button" id="checkout-button">
        Proceed to Checkout
      </button>
      
      <!-- Detailed Receipt Section -->
      <div class="receipt" id="detailed-receipt">
        <h2>Order Details</h2>
        <table>
          <thead>
            <tr>
              <th>Item</th>
              <th>Qty</th>
              <th>Unit Price</th>
              <th>Line Total</th>
            </tr>
          </thead>
          <tbody id="receipt-body">
            <!-- Receipt details will be rendered here -->
          </tbody>
        </table>
      </div>
      
      <!-- Token System Section -->
      <div class="token-section">
        <h2>Apply Tokens</h2>
        <p>You have <span id="user-tokens">50</span> tokens available.</p>
        <input type="number" id="token-input" placeholder="Tokens to apply" min="0" />
        <button id="apply-tokens">Apply Tokens</button>
        <p id="token-message"></p>
      </div>
    </main>
    
    <!-- External Footer -->
    <div id="footer-placeholder"></div>
    
    <!-- JavaScript for cart functionality -->
    <script>
      /*
        This frontend code uses dummy data and is structured for future integration with Firebase.
        The global state management here will eventually be replaced with Firebase Firestore API calls,
        and authentication/data persistence will be handled via Firebase.
      */
      
      // Global cart items (dummy data)
      let cartItems = [
        {
          id: 1,
          name: "Product 1",
          price: 29.99,
          quantity: 1,
          image: "https://via.placeholder.com/80"
        },
        {
          id: 2,
          name: "Product 2",
          price: 49.99,
          quantity: 2,
          image: "https://via.placeholder.com/80"
        },
        {
          id: 3,
          name: "Product 3",
          price: 19.99,
          quantity: 1,
          image: "https://via.placeholder.com/80"
        }
      ];
      
      // Token system: dummy user tokens and applied tokens
      let userTokens = 50;
      let appliedTokens = 0;
      
      // Render the cart items, update totals, and display a detailed receipt.
      const renderCart = () => {
        const cartItemsContainer = document.getElementById("cart-items");
        const cartTotalContainer = document.getElementById("cart-total");
        const receiptBody = document.getElementById("receipt-body");
        
        if (cartItems.length === 0) {
          cartItemsContainer.innerHTML =
            '<p class="empty-cart">Your cart is empty.</p>';
          cartTotalContainer.innerText = "Total: $0.00";
          receiptBody.innerHTML = "";
          return;
        }
        
        let total = 0;
        cartItemsContainer.innerHTML = "";
        receiptBody.innerHTML = "";
        
        cartItems.forEach((item) => {
          const lineTotal = item.price * item.quantity;
          total += lineTotal;
          
          // Render cart item with quantity controls and a "Remove" button within the details.
          const itemEl = document.createElement("div");
          itemEl.className = "cart-item";
          itemEl.innerHTML = `
            <img src="${item.image}" alt="${item.name}" />
            <div class="cart-item-details">
              <h3>${item.name}</h3>
              <p>$${item.price.toFixed(2)} x ${item.quantity} = $${lineTotal.toFixed(2)}</p>
              <div class="quantity-controls">
                <button onclick="updateQuantity(${item.id}, ${item.quantity - 1})" title="Decrease Quantity">
                  <i class="fas fa-minus"></i>
                </button>
                <span id="quantity-${item.id}">${item.quantity}</span>
                <button onclick="updateQuantity(${item.id}, ${item.quantity + 1})" title="Increase Quantity">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
              <button class="remove-button" onclick="removeItem(${item.id})">Remove</button>
            </div>
          `;
          cartItemsContainer.appendChild(itemEl);
          
          // Render detailed receipt row.
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>$${item.price.toFixed(2)}</td>
            <td>$${lineTotal.toFixed(2)}</td>
          `;
          receiptBody.appendChild(row);
        });
        
        // Apply token discount: assume each token gives a $0.10 discount.
        const tokenDiscount = appliedTokens * 0.10;
        const finalTotal = Math.max(total - tokenDiscount, 0);
        cartTotalContainer.innerText = "Total: $" + finalTotal.toFixed(2);
      };
      
      // Update the quantity for a specific item.
      function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) return;
        const index = cartItems.findIndex(item => item.id === itemId);
        if (index > -1) {
          cartItems[index].quantity = newQuantity;
          renderCart();
        }
      }
      
      // Remove an item from the cart.
      function removeItem(itemId) {
        cartItems = cartItems.filter(item => item.id !== itemId);
        renderCart();
      }
      
      // Load external HTML for header and footer.
      const loadHTML = (elementId, filePath) => {
        fetch(filePath)
          .then(response => {
            if (!response.ok) {
              throw new Error("Error fetching " + filePath);
            }
            return response.text();
          })
          .then(html => {
            document.getElementById(elementId).innerHTML = html;
          })
          .catch(error => console.error(error));
      };
      
      // Apply tokens to the order.
      function applyTokens() {
        const tokenInput = document.getElementById("token-input");
        const tokensToApply = parseInt(tokenInput.value);
        const tokenMessage = document.getElementById("token-message");
        
        if (isNaN(tokensToApply) || tokensToApply < 0) {
          tokenMessage.innerText = "Please enter a valid number of tokens.";
          return;
        }
        if (tokensToApply > userTokens) {
          tokenMessage.innerText = "You do not have enough tokens.";
          return;
        }
        appliedTokens = tokensToApply;
        tokenMessage.innerText = "Tokens applied: " + appliedTokens;
        renderCart();
      }
      
      // Activate header hamburger icon if present.
      function activateHeaderMenu() {
        const menuToggle = document.querySelector(".menu-toggle");
        if (menuToggle) {
          menuToggle.addEventListener("click", () => {
            const sideMenu = document.getElementById("side-menu");
            if (sideMenu) {
              sideMenu.classList.toggle("visible");
            }
          });
        }
      }
      
      // Initialize the cart page on DOM load.
      document.addEventListener("DOMContentLoaded", () => {
        renderCart();
        loadHTML("header-placeholder", "header.html");
        loadHTML("footer-placeholder", "footer.html");
        document.getElementById("apply-tokens").addEventListener("click", applyTokens);
        document.getElementById("checkout-button").addEventListener("click", () => {
          // Future implementation: trigger Firebase Authentication & payment flow.
          alert("Proceeding to checkout...");
        });
        // Display the available tokens.
        document.getElementById("user-tokens").innerText = userTokens;
        // Activate header hamburger menu if it exists.
        activateHeaderMenu();
      });
    </script>
  </body>
</html>
