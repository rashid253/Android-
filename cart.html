<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Details - NextGen E-commerce</title>
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Bootstrap 5 CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Global Styles -->
    <link rel="stylesheet" href="style.css" />
    <!-- Custom JavaScript -->
    <script src="script.js" defer></script>
    <style>
      /* Additional overrides for details.html */
      body {
        margin-top: 70px;
        scroll-behavior: smooth;
      }
      .section-nav {
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 999;
      }
      .section-nav .nav-link {
        color: #007bff;
        font-weight: bold;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 10px 0;
      }
      .section-nav .nav-link i {
        font-size: 1.5rem;
        margin-bottom: 5px;
      }
      .section-nav .nav-link:hover {
        color: #0056b3;
      }
      .description-content {
        max-height: 150px;
        overflow: hidden;
        transition: max-height 0.4s ease;
      }
      .description-content.expanded {
        max-height: 1000px;
      }
      .review-full {
        display: none;
      }
      .review-full.expanded {
        display: block;
      }
      .star-icon {
        cursor: pointer;
        color: #ccc;
      }
      .star-icon.selected {
        color: #f5c518;
      }
    </style>
  </head>
  <body>
    <!-- External Header will be loaded here -->
    <div id="header-placeholder"></div>

    <!-- Product Details Section -->
    <div class="container mt-5 mb-5">
      <div class="row">
        <!-- Product Image -->
        <div class="col-md-5 text-center mb-3">
          <img
            id="productImage"
            src="https://via.placeholder.com/400x300?text=Product+Image"
            alt="Product Image"
            class="img-fluid rounded"
          />
        </div>
        <!-- Product Info -->
        <div class="col-md-7">
          <h2 id="productName">Product Name</h2>
          <p class="h5 text-primary" id="productPrice">PKR 0</p>
          <div id="productRating" class="star-rating mb-2"></div>
          <p id="productStats" class="text-muted mb-3">0 Added | 0 Sold</p>
          <button class="btn btn-success add-to-cart-btn mt-3">
            <i class="fa fa-shopping-cart"></i> Add to Cart
          </button>
        </div>
      </div>
    </div>

    <!-- Section Navigation Bar -->
    <nav class="section-nav">
      <div class="container d-flex justify-content-around">
        <a class="nav-link" href="#section-description">
          <i class="fa fa-file-text"></i>
          <span>Description</span>
        </a>
        <a class="nav-link" href="#section-reviews">
          <i class="fa fa-comments"></i>
          <span>Reviews</span>
        </a>
        <a class="nav-link" href="#section-related">
          <i class="fa fa-th"></i>
          <span>Related Items</span>
        </a>
      </div>
    </nav>

    <!-- Description Section -->
    <section id="section-description" class="container mt-4 mb-5">
      <h3>Description</h3>
      <div class="description-content" id="descriptionContent">
        <p id="productDescription">
          Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec vel
          mauris quam. Praesent sed nisi eleifend, varius nulla eu, auctor urna.
          Vestibulum ante ipsum primis in faucibus orci luctus et ultrices
          posuere cubilia curae; Suspendisse potenti. Proin ut tincidunt mauris,
          vel dapibus nulla. Nulla facilisi. Sed nec nulla vitae eros aliquet
          fermentum.
        </p>
      </div>
      <button class="btn btn-sm btn-outline-primary mt-2" id="descReadMore">
        Read More
      </button>
    </section>

    <!-- Reviews Section -->
    <section id="section-reviews" class="container mb-5">
      <h3>Reviews</h3>
      <div id="reviewsContainer">
        <div class="card mb-3">
          <div class="card-body">
            <p>
              <strong>User1:</strong> Amazing quality, highly recommended!
              <span class="review-read-more text-primary" style="cursor: pointer">...Read more</span>
            </p>
            <p class="text-muted"><small>Reviewed on July 10, 2025</small></p>
            <p class="review-full" style="margin-bottom: 0">
              Full review text for User1. Lorem ipsum dolor sit amet, consectetur
              adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore
              magna aliqua.
            </p>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-body">
            <p>
              <strong>User2:</strong> Good value for money.
              <span class="review-read-more text-primary" style="cursor: pointer">...Read more</span>
            </p>
            <p class="text-muted"><small>Reviewed on July 8, 2025</small></p>
            <p class="review-full" style="margin-bottom: 0">
              Full review text for User2. Additional details about the product
              experience go here.
            </p>
          </div>
        </div>
      </div>

      <!-- Write a Review -->
      <div class="card">
        <div class="card-body">
          <h5>Write a Review</h5>
          <div id="ratingStars" class="mb-2">
            <i class="fa fa-star star-icon" data-value="1"></i>
            <i class="fa fa-star star-icon" data-value="2"></i>
            <i class="fa fa-star star-icon" data-value="3"></i>
            <i class="fa fa-star star-icon" data-value="4"></i>
            <i class="fa fa-star star-icon" data-value="5"></i>
          </div>
          <textarea class="form-control mb-2" rows="3" placeholder="Share your experience after purchasing"></textarea>
          <button class="btn btn-success">Submit Review</button>
        </div>
      </div>
    </section>

    <!-- Related Items Section -->
    <section id="section-related" class="container mb-5">
      <h3>Related Items</h3>
      <div class="row" id="relatedItemsContainer">
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center">
            <img src="https://via.placeholder.com/140x100?text=Item+1" alt="Item 1" class="card-img-top" />
            <div class="card-body p-2">
              <p class="small mb-0">Item 1</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center">
            <img src="https://via.placeholder.com/140x100?text=Item+2" alt="Item 2" class="card-img-top" />
            <div class="card-body p-2">
              <p class="small mb-0">Item 2</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center">
            <img src="https://via.placeholder.com/140x100?text=Item+3" alt="Item 3" class="card-img-top" />
            <div class="card-body p-2">
              <p class="small mb-0">Item 3</p>
            </div>
          </div>
        </div>
        <div class="col-6 col-md-3 mb-3">
          <div class="card text-center">
            <img src="https://via.placeholder.com/140x100?text=Item+4" alt="Item 4" class="card-img-top" />
            <div class="card-body p-2">
              <p class="small mb-0">Item 4</p>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- External Footer will be loaded here -->
    <div id="footer-placeholder"></div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Load cart items from localStorage.
      let cartItems = JSON.parse(localStorage.getItem("cartItems")) || [];
      let userTokens = 50;
      let appliedTokens = 0;
      let updateTimer;
      const DEBOUNCE_DELAY = 300;

      // New function to remove items with invalid (NaN or null) quantity.
      function cleanCart() {
        cartItems = cartItems.filter(item => {
          const qty = Number(item.quantity);
          return !isNaN(qty) && qty !== null;
        });
        localStorage.setItem("cartItems", JSON.stringify(cartItems));
      }

      function renderCartItems() {
        const container = document.getElementById("cart-items");
        if (cartItems.length === 0) {
          container.innerHTML = '<p class="empty-cart">Your cart is empty.</p>';
          return;
        }
        container.innerHTML = "";
        cartItems.forEach(item => {
          const div = document.createElement("div");
          div.className = "cart-item";
          div.innerHTML = `
            <input type="checkbox" class="delete-checkbox" data-id="${item.id}" />
            <img src="${item.image}" alt="${item.name}">
            <div class="cart-item-details">
              <h3>${item.name}</h3>
              <p>Price: Rs ${parseFloat(item.price).toFixed(2)} | Qty: <span id="quantity-${item.id}">${item.quantity}</span></p>
            </div>
            <div class="quantity-vertical">
              <button onclick="increaseQuantity(${item.id})" title="Increase Quantity">
                <i class="fas fa-plus"></i>
              </button>
              <span id="vertical-qty-${item.id}">${item.quantity}</span>
              <button onclick="decreaseQuantity(${item.id})" title="Decrease Quantity">
                <i class="fas fa-minus"></i>
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }
      
      function increaseQuantity(itemId) {
        const index = cartItems.findIndex(item => item.id === itemId);
        if (index > -1) {
          updateQuantity(itemId, cartItems[index].quantity + 1);
        }
      }
      
      function decreaseQuantity(itemId) {
        const index = cartItems.findIndex(item => item.id === itemId);
        if (index > -1 && cartItems[index].quantity > 1) {
          updateQuantity(itemId, cartItems[index].quantity - 1);
        }
      }
      
      function updateQuantity(itemId, newQuantity) {
        if (newQuantity < 1) return;
        const index = cartItems.findIndex(item => item.id === itemId);
        if (index > -1) {
          cartItems[index].quantity = newQuantity;
          document.getElementById("quantity-" + itemId).innerText = newQuantity;
          document.getElementById("vertical-qty-" + itemId).innerText = newQuantity;
          clearTimeout(updateTimer);
          updateTimer = setTimeout(updateTotals, DEBOUNCE_DELAY);
        }
      }
      
      function updateTotals() {
        const totalContainer = document.getElementById("cart-total");
        const receiptBody = document.getElementById("receipt-body");
        let total = 0;
        receiptBody.innerHTML = "";
        cartItems.forEach(item => {
          const lineTotal = parseFloat(item.price) * item.quantity;
          total += lineTotal;
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>Rs ${parseFloat(item.price).toFixed(2)}</td>
            <td>Rs ${lineTotal.toFixed(2)}</td>
          `;
          receiptBody.appendChild(row);
        });
        const tokenDiscount = appliedTokens * 0.10;
        const finalTotal = Math.max(total - tokenDiscount, 0);
        totalContainer.innerText = "Total: Rs " + finalTotal.toFixed(2);
        localStorage.setItem("cartItems", JSON.stringify(cartItems));
      }
      
      function updateTrashCount() {
        const checked = document.querySelectorAll(".delete-checkbox:checked");
        document.getElementById("trash-count").innerText = checked.length;
      }
      
      // Updated delete function: clean invalid items first.
      function deleteSelectedItems() {
        cleanCart();
        const checked = document.querySelectorAll(".delete-checkbox:checked");
        if (checked.length === 0) {
          alert("Please select at least one item to delete.");
          return;
        }
        if (!confirm("Are you sure you want to delete the selected items?")) return;
        const ids = Array.from(checked).map(cb => Number(cb.getAttribute("data-id")));
        cartItems = cartItems.filter(item => !ids.includes(item.id));
        renderCartItems();
        updateTotals();
        updateTrashCount();
        localStorage.setItem("cartItems", JSON.stringify(cartItems));
      }
      
      function loadHTML(elementId, filePath) {
        return fetch(filePath)
          .then(response => {
            if (!response.ok) throw new Error("Error fetching " + filePath);
            return response.text();
          })
          .then(html => {
            document.getElementById(elementId).innerHTML = html;
          })
          .catch(error => console.error(error));
      }
      
      function applyTokens() {
        const tokenInput = document.getElementById("token-input");
        const tokens = parseInt(tokenInput.value);
        const tokenMsg = document.getElementById("token-message");
        if (isNaN(tokens) || tokens < 0) {
          tokenMsg.innerText = "Please enter a valid number of tokens.";
          return;
        }
        if (tokens > userTokens) {
          tokenMsg.innerText = "You do not have enough tokens.";
          return;
        }
        appliedTokens = tokens;
        tokenMsg.innerText = "Tokens applied: " + appliedTokens;
        updateTotals();
      }
      
      document.addEventListener("DOMContentLoaded", () => {
        cleanCart();
        renderCartItems();
        updateTotals();
        loadHTML("header-placeholder", "header.html");
        loadHTML("footer-placeholder", "footer.html");
        document.addEventListener("change", event => {
          if (event.target.classList.contains("delete-checkbox")) {
            updateTrashCount();
          }
        });
        document.getElementById("trash-bin-container").addEventListener("click", deleteSelectedItems);
        document.getElementById("apply-tokens").addEventListener("click", applyTokens);
        document.getElementById("checkout-button").addEventListener("click", () => {
          window.location.href = "checkout.html";
        });
        if(document.getElementById("user-tokens")){
          document.getElementById("user-tokens").innerText = userTokens;
        }
      });
    </script>
  </body>
</html>
